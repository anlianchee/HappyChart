<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XXæˆ€æ„›ç‰©èª - å°ˆæ¡ˆç®¡ç†</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --category-color-1: #3498db; /* Gameplay è—è‰² */
            --category-color-2: #9b59b6; /* åŠ‡æƒ…å‹•ç•« ç´«è‰² */
            --category-color-3: #e74c3c; /* ç´„æœƒå‹•ç•« ç´…è‰² */
            --bg-color: #F4F7F6;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #333333;
            --text-muted: #888888;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('bg.png'); 
            background-size: cover;          
            background-position: center;     
            background-attachment: fixed;    
            color: var(--text-main);
            padding: 20px 20px;
            max-width: 1000px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        .header-nav { display: flex; align-items: center; margin-bottom: 20px; position: relative; flex-wrap: wrap; gap: 15px;}
        .back-btn {
            background: #FFFFFF; border: 2px solid #E0E0E0; padding: 8px 15px; margin-right: 15px;
            border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: all 0.2s; display: none; 
        }
        .back-btn:hover { background: #f0f0f0; transform: translateX(-3px); }
        
        /* å°ˆæ¡ˆæ¨™é¡Œèˆ‡ç·¨è¼¯æŒ‰éˆ• */
        .main-title-wrapper { display: flex; align-items: center; gap: 10px; }
        .main-title { font-size: 32px; margin: 0; font-weight: 800; text-shadow: 0 2px 4px rgba(255,255,255,0.8); }
        .header-edit-btn { font-size: 20px; cursor: pointer; opacity: 0; transition: 0.2s ease; }
        .main-title-wrapper:hover .header-edit-btn { opacity: 0.5; }
        .header-edit-btn:hover { opacity: 1 !important; transform: scale(1.1); }

        .roadmap-container {
            display: flex; align-items: center; margin-left: 20px;
            background: rgba(255, 255, 255, 0.6); padding: 5px 15px; border-radius: 30px; backdrop-filter: blur(5px);
        }
        .roadmap-node {
            display: flex; align-items: center; padding: 6px 14px; border-radius: 20px; 
            font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; user-select: none;
        }
        .roadmap-edit { font-size: 12px; margin-left: 6px; opacity: 0; transition: 0.2s; }
        .roadmap-delete { font-size: 10px; margin-left: 6px; opacity: 0; transition: 0.2s; color: #e74c3c; font-weight: bold; padding: 2px;}
        .roadmap-node:hover .roadmap-edit, .roadmap-node:hover .roadmap-delete { opacity: 0.6; }
        .roadmap-edit:hover, .roadmap-delete:hover { opacity: 1 !important; transform: scale(1.2); }
        
        .state-todo { background: #EEEEEE; color: #999; }
        .state-todo:hover { background: #E0E0E0; }
        .state-doing { 
            background: #E3F2FD; color: #0288D1; box-shadow: 0 0 0 2px #0288D1 inset;
            animation: breath 2s infinite ease-in-out;
        }
        .state-done { background: var(--primary-color); color: white; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4); }
        
        .roadmap-line { width: 25px; height: 3px; background: #EEEEEE; margin: 0 5px; transition: 0.3s; border-radius: 2px;}
        
        /* Roadmap æ–°å¢æŒ‰éˆ• */
        .roadmap-add-btn {
            display: flex; align-items: center; justify-content: center;
            width: 26px; height: 26px; border-radius: 50%; background: #EEEEEE; color: #888;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;
            margin-left: 10px; border: 2px dashed #cccccc;
        }
        .roadmap-add-btn:hover { background: #E0E0E0; border-color: #aaa; color: #555; transform: scale(1.1); }

        @keyframes breath {
            0% { box-shadow: 0 0 0 2px #0288D1 inset, 0 0 0 0 rgba(2, 136, 209, 0.4); }
            70% { box-shadow: 0 0 0 2px #0288D1 inset, 0 0 0 8px rgba(2, 136, 209, 0); }
            100% { box-shadow: 0 0 0 2px #0288D1 inset, 0 0 0 0 rgba(2, 136, 209, 0); }
        }

        /* é–å®šæŒ‰éˆ•èˆ‡æ©¡çš®æ“¦çš„å®¹å™¨ */
        .header-controls {
            margin-left: auto; display: flex; align-items: center; gap: 12px;
        }

        .lock-btn {
            background: transparent; border: none; font-size: 22px; cursor: pointer;
            opacity: 0.5; transition: all 0.3s ease; padding: 5px; outline: none;
            filter: grayscale(0.8);
        }
        .lock-btn:hover { opacity: 0.9; transform: scale(1.1); filter: grayscale(0); }
        
        /* é–å®šæ¨¡å¼ä¸‹éš±è—æ‰€æœ‰å¢åˆªæ”¹æŒ‰éˆ• */
        body.locked-mode .delete-btn,
        body.locked-mode .add-btn,
        body.locked-mode .roadmap-delete,
        body.locked-mode .roadmap-add-btn,
        body.locked-mode .edit-btn,
        body.locked-mode .header-edit-btn,
        body.locked-mode .roadmap-edit {
            display: none !important;
        }

        .eraser-btn {
            background: #FFFFFF; border: 2px solid #E0E0E0; padding: 8px 15px;
            border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px;
            color: #888; transition: all 0.3s; display: none; align-items: center; gap: 8px;
        }
        .eraser-btn:hover { border-color: #ff9999; color: #e74c3c; }
        .eraser-btn.active {
            background: #ffebee; border-color: #e74c3c; color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .project-overview-panel {
            background: var(--card-bg); border-radius: 20px; padding: 30px;
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px;
            display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(10px);
        }
        
        .ring-container {
            position: relative; width: 180px; height: 180px; margin: 30px auto 60px auto; 
            display: flex; justify-content: center; align-items: center;
        }

        .click-zone {
            position: absolute; cursor: pointer; display: flex; justify-content: center; align-items: center;
            z-index: 10; padding: 10px 15px; 
        }

        .zone-label { font-size: 24px; font-weight: 900; pointer-events: none; white-space: nowrap; }

        /* èª¿æ•´äº†åç§»é‡ï¼Œç¢ºä¿æ–‡å­—ä¸æœƒç©¿éåœ“ç’°é¡è‰²å€åŸŸ */
        .zone-left { right: 100%; top: 50%; transform: translate(-50px, -50%); }
        .zone-right { left: 100%; top: 50%; transform: translate(50px, -50%); }
        .zone-bottom { top: 100%; left: 50%; transform: translate(-50%, 25px); }

        .big-progress-ring {
            width: 180px; height: 180px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            background: conic-gradient(#E0E0E0 0%, #E0E0E0 100%); 
            position: relative; transition: background 1s ease-out; z-index: 5; 
        }
        .big-progress-ring::before { content: ""; position: absolute; width: 145px; height: 145px; background-color: #FFFFFF; border-radius: 50%; }
        .big-progress-text { position: relative; font-size: 40px; font-weight: 900; color: #333; z-index: 100; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        .category-card {
            background: var(--card-bg); border-radius: 20px; padding: 25px 20px; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; backdrop-filter: blur(5px);
            transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; align-items: center; gap: 12px;
        }
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .category-card:hover .edit-btn, .category-card:hover .delete-btn { opacity: 0.5; } /* é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• */
        
        .cat-title { font-size: 22px; font-weight: bold; }
        .med-progress-ring {
            width: 100px; height: 100px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            position: relative; transition: background 0.8s;
        }
        .med-progress-ring::before { content: ""; position: absolute; width: 80px; height: 80px; background-color: #FFFFFF; border-radius: 50%; }
        .med-progress-text { position: relative; font-size: 20px; font-weight: bold; }

        .centered-title-wrapper { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; }
        .centered-title-wrapper::before { content: ""; } 
        .centered-title-wrapper .cat-title { text-align: center; }
        .centered-title-wrapper .edit-wrapper { justify-self: start; padding-left: 8px; } 

        .task-card {
            background: var(--card-bg); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; overflow: hidden; border: 2px solid transparent; transition: all 0.3s ease; position: relative;
        }
        .task-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; cursor: pointer; user-select: none; }
        .task-header:hover { background-color: rgba(250, 250, 250, 0.5); }
        .title-wrapper { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .task-title { font-size: 18px; font-weight: bold; margin: 0; color: #333; }
        
        .progress-ring {
            width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            position: relative; transition: background 0.6s;
        }
        .progress-ring::before { content: ""; position: absolute; width: 38px; height: 38px; background-color: #FFFFFF; border-radius: 50%; transition: background-color 0.3s; }
        .progress-text { position: relative; font-weight: bold; font-size: 13px; }

        .subtasks { display: flex; flex-direction: column; gap: 10px; padding: 0 25px 25px 25px; border-top: 1px solid rgba(238, 238, 238, 0.5); }
        .subtask-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 15px; padding: 6px; border-radius: 8px; margin-top: 5px; }
        .subtask-label:hover { background-color: rgba(240, 240, 240, 0.8); }
        .subtask-checkbox { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; }
        .completed-text { text-decoration: line-through; color: var(--text-muted); }

        .card-completed { background-color: rgba(240, 255, 240, 0.95); border: 2px solid var(--primary-color); box-shadow: 0 0 20px rgba(76, 175, 80, 0.2); }
        .card-completed .task-header { background-color: transparent; }
        .card-completed .progress-ring::before { background-color: #F0FFF0; }

        .delete-btn {
            position: absolute; top: 8px; right: 10px; font-size: 12px; color: rgba(0, 0, 0, 0.2);
            background: transparent; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 10; transition: all 0.2s; opacity: 0;
        }
        .delete-btn:hover { color: #ffffff; background-color: rgba(231, 76, 60, 0.8); opacity: 1 !important; }
        .task-card:hover .delete-btn { opacity: 0.5; }

        .add-btn {
            width: 100%; margin-top: 30px; padding: 18px; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px);
            border: 2px dashed #cccccc; border-radius: 15px; color: #888888;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-align: center;
        }
        .add-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background-color: rgba(240, 255, 240, 0.9); transform: translateY(-2px); }

        .edit-btn { font-size: 14px; cursor: pointer; opacity: 0; transition: all 0.2s ease; padding: 4px; border-radius: 4px; }
        .centered-title-wrapper:hover .edit-btn, .title-wrapper:hover .edit-btn, .subtask-label:hover .edit-btn { opacity: 0.5; }
        .edit-btn:hover { opacity: 1 !important; background-color: #e0e0e0; transform: scale(1.1); }

        .eraser-mode-active, .eraser-mode-active * { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="%23ffcccc" stroke="%23e74c3c" stroke-width="2"><path d="M20 20H7L3 16C2.5 15.5 2.5 14.5 3 14L13 4C13.5 3.5 14.5 3.5 15 4L20 9C20.5 9.5 20.5 10.5 20 11L11 20H20V20Z"/></svg>') 4 20, crosshair !important; }
        .eraser-overlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 50; }
        .eraser-mode-active .eraser-overlay { display: block; }
        .eraser-mode-active .task-card:hover { border-color: #ff9999; background-color: #fffafa; }

        .confetti { position: fixed; border-radius: 50%; pointer-events: none; z-index: 99999; animation: burst 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes burst { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        #view-project { display: block; }
        #view-category { display: none; }
        #view-group { display: none; }
        
        .top-progress-container { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 20px 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="locked-mode">

    <div class="header-nav">
        <button class="back-btn" id="btn-back">â† è¿”å›</button>
        <div class="main-title-wrapper">
            <h1 class="main-title" id="page-title">XXæˆ€æ„›ç‰©èª</h1>
            <span class="header-edit-btn" onclick="renameProject(event)" title="ä¿®æ”¹å°ˆæ¡ˆåç¨±">âœï¸</span>
        </div>
        
        <div id="roadmap-container" class="roadmap-container"></div>
        
        <div class="header-controls">
            <button class="eraser-btn" id="btn-eraser" onclick="toggleEraserMode()">ğŸ§¹ æ©¡çš®æ“¦ (OFF)</button>
            <button id="btn-lock" class="lock-btn" onclick="toggleLockMode()" title="åˆ‡æ›ç·¨è¼¯æ¨¡å¼">ğŸ”’</button>
        </div>
    </div>

    <div id="view-project">
        <div class="project-overview-panel" id="project-panel-content"></div>
        <div class="grid-container" id="category-container"></div>
    </div>

    <div id="view-category">
        <div class="top-progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <strong style="font-size: 18px;" id="cat-detail-name">åˆ†é¡é€²åº¦</strong>
                <strong id="cat-detail-text">0%</strong>
            </div>
            <div style="width: 100%; height: 20px; background: #E0E0E0; border-radius: 10px; overflow: hidden;">
                <div id="cat-detail-fill" style="height: 100%; background: var(--primary-color); width: 0%; transition: 0.5s;"></div>
            </div>
        </div>
        <div class="grid-container" id="group-container"></div>
        <button class="add-btn" id="add-group-btn" onclick="addGroup()">+ æ–°å¢ç« ç¯€ / ç¾¤çµ„</button>
    </div>

    <div id="view-group">
        <div class="top-progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <strong style="font-size: 18px;" id="grp-detail-name">ç« ç¯€/ä»»å‹™ é€²åº¦</strong>
                <strong id="grp-detail-text">0%</strong>
            </div>
            <div style="width: 100%; height: 20px; background: #E0E0E0; border-radius: 10px; overflow: hidden;">
                <div id="grp-detail-fill" style="height: 100%; background: var(--primary-color); width: 0%; transition: 0.5s;"></div>
            </div>
        </div>
        <div class="grid-container" id="task-container"></div>
        <button class="add-btn" id="add-task-btn" onclick="addTask()">+ æ–°å¢ä»»å‹™</button>
    </div>

    <script>
        const STORAGE_KEY = 'IslandProject_Data_v34'; // æ›´æ–°äº†ç‰ˆæœ¬è™Ÿ
        let isLocked = true; // é è¨­ç‚ºé–å®šæ¨¡å¼

        const initData = {
            projectName: "XXæˆ€æ„›ç‰©èª",
            roadmap: [
                { name: "ç¯€é» 1", state: "done" },   
                { name: "ç¯€é» 2", state: "doing" },
                { name: "ç¯€é» 3", state: "todo" }
            ],
            categories: [
                {
                    id: "cat_gameplay", name: "Game play", color: "var(--category-color-1)", hasLayers: true,
                    groups: [
                        { name: "Idleå‹•ç•«", tasks: Array.from({length: 2}, (_, i) => ({ id: `idle${i}`, title: `Idle ${i+1}`, expanded: false, subtasks: [ {name: "Blocking", done: false}, {name: "Spline", done: false}, {name: "Polish", done: false}, {name: "è¼¸å‡º", done: false} ] })) },
                        { name: "Actå‹•ç•«", tasks: Array.from({length: 2}, (_, i) => ({ id: `act${i}`, title: `Act ${i+1}`, expanded: false, subtasks: [ {name: "Blocking", done: false}, {name: "Spline", done: false}, {name: "Polish", done: false}, {name: "è¼¸å‡º", done: false} ] })) }
                    ]
                },
                {
                    id: "cat_cutscene", name: "åŠ‡æƒ…å‹•ç•«", color: "var(--category-color-2)", hasLayers: true, 
                    groups: [
                        { name: "S01", tasks: Array.from({length: 6}, (_, i) => ({ id: `s01c${String(i+1).padStart(2, '0')}`, title: `S01C${String(i+1).padStart(2, '0')}`, expanded: false, subtasks: [ {name: "Blocking", done: false}, {name: "Spline", done: false}, {name: "Polish", done: false}, {name: "Render è¼¸å‡º", done: false} ] })) }
                    ]
                },
                {
                    id: "cat_h", name: "ç´„æœƒå‹•ç•«", color: "var(--category-color-3)", hasLayers: false,
                    groups: [
                        { name: "é è¨­ç¾¤çµ„", tasks: Array.from({length: 5}, (_, i) => ({ id: `h${i}`, title: `ç´„æœƒ Scene ${i+1}`, expanded: false, subtasks: [ {name: "keypose", done: false}, {name: "idle_breath_loop", done: false}, {name: "start", done: false}, {name: "slow_loop", done: false}, {name: "high_loop", done: false}, {name: "end", done: false}, {name: "end_breath_loop", done: false}, {name: "æ•´ç†æª”æ¡ˆ", done: false}, {name: "è¼¸å‡ºunityæª¢æŸ¥", done: false} ] })) }
                    ]
                }
            ]
        };

        let projectData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initData;

        let activeCategoryIndex = null; 
        let activeGroupIndex = null; 
        let isEraserMode = false; 

        // --- æ–°å¢åŠŸèƒ½å€ ---
        function toggleLockMode() {
            isLocked = !isLocked;
            document.body.classList.toggle('locked-mode', isLocked);
            document.getElementById('btn-lock').innerText = isLocked ? 'ğŸ”’' : 'ğŸ”“';
            if (isLocked && isEraserMode) toggleEraserMode(); // é–å®šæ™‚è‡ªå‹•é—œé–‰æ©¡çš®æ“¦
        }

        function renameProject(event) {
            event.stopPropagation();
            if (isLocked) return;
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„å°ˆæ¡ˆåç¨±ï¼š", projectData.projectName);
            if (newName && newName.trim() !== "") {
                projectData.projectName = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                document.getElementById('page-title').innerText = projectData.projectName;
            }
        }

        function addRoadmapNode() {
            if (isLocked) return;
            const newName = prompt("è«‹è¼¸å…¥æ–°éšæ®µåç¨±ï¼š", `æ–°éšæ®µ ${projectData.roadmap.length + 1}`);
            if (newName && newName.trim() !== "") {
                projectData.roadmap.push({ name: newName.trim(), state: "todo" });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderRoadmap();
            }
        }

        function deleteRoadmapNode(index, event) {
            event.stopPropagation();
            if (isLocked) return;
            const nodeName = projectData.roadmap[index].name;
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é€²åº¦ç¯€é»ã€Œ${nodeName}ã€å—ï¼Ÿ`)) {
                projectData.roadmap.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderRoadmap();
            }
        }

        function deleteCategory(index, event) {
            event.stopPropagation();
            if (isLocked) return;
            const catName = projectData.categories[index].name;
            if (confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤æ•´å€‹å¤§åˆ†é¡ã€Œ${catName}ã€å—ï¼Ÿ\nè£¡é¢çš„æ‰€æœ‰ç« ç¯€å’Œä»»å‹™éƒ½æœƒä¸€ä½µæ¶ˆå¤±ä¸”ç„¡æ³•å¾©åŸå–”ï¼`)) {
                projectData.categories.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderProjectView();
            }
        }
        // ------------------

        function renderRoadmap() {
            const container = document.getElementById('roadmap-container');
            container.innerHTML = '';
            
            projectData.roadmap.forEach((node, index) => {
                const pill = document.createElement('div');
                pill.className = `roadmap-node state-${node.state}`;
                pill.onclick = () => toggleRoadmapNode(index);
                
                let icon = '';
                if (node.state === 'done') icon = 'âœ” ';
                if (node.state === 'doing') icon = 'â–¶ ';
                
                pill.innerHTML = `
                    <span>${icon}${node.name}</span>
                    <span class="roadmap-edit" onclick="renameRoadmapNode(${index}, event)" title="é‡æ–°å‘½å">âœï¸</span>
                    <span class="roadmap-delete" onclick="deleteRoadmapNode(${index}, event)" title="åˆªé™¤ç¯€é»">âœ•</span>
                `;
                container.appendChild(pill);
                
                if (index < projectData.roadmap.length - 1) {
                    const line = document.createElement('div');
                    line.className = 'roadmap-line';
                    if (node.state === 'done') line.style.background = 'var(--primary-color)';
                    container.appendChild(line);
                }
            });

            // åŠ å…¥ Roadmap çš„æ–°å¢æŒ‰éˆ•
            const addBtn = document.createElement('div');
            addBtn.className = 'roadmap-add-btn';
            addBtn.innerText = '+';
            addBtn.onclick = addRoadmapNode;
            addBtn.title = 'æ–°å¢é€²åº¦ç¯€é»';
            container.appendChild(addBtn);
        }

        function toggleRoadmapNode(index) {
            if (isEraserMode || isLocked) return;
            const states = ['todo', 'doing', 'done'];
            const currentState = projectData.roadmap[index].state;
            let nextIndex = (states.indexOf(currentState) + 1) % states.length;
            projectData.roadmap[index].state = states[nextIndex];
            
            if (states[nextIndex] === 'done') {
                const nodes = document.querySelectorAll('.roadmap-node');
                const rect = nodes[index].getBoundingClientRect();
                fireConfetti(rect.left + rect.width/2, rect.top + rect.height/2, 20, false);
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            renderRoadmap();
        }

        function renameRoadmapNode(index, event) {
            event.stopPropagation(); 
            if (isEraserMode || isLocked) return;
            const currentName = projectData.roadmap[index].name;
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„è·¯ç·šåœ–ç¯€é»åç¨±ï¼š", currentName);
            if (newName && newName.trim() !== "") {
                projectData.roadmap[index].name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderRoadmap();
            }
        }

        function getTaskStats(task) {
            const total = task.subtasks.length;
            const done = task.subtasks.filter(st => st.done).length;
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }
        function getGroupStats(group) {
            let total = 0, done = 0;
            group.tasks.forEach(t => { const s = getTaskStats(t); total += s.total; done += s.done; });
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }
        function getCategoryStats(category) {
            let total = 0, done = 0;
            category.groups.forEach(g => { const s = getGroupStats(g); total += s.total; done += s.done; });
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }
        function getProjectStats() {
            let total = 0, done = 0;
            projectData.categories.forEach(c => { const s = getCategoryStats(c); total += s.total; done += s.done; });
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }

        function toggleEraserMode() {
            if (isLocked) return; 
            isEraserMode = !isEraserMode;
            const btn = document.getElementById('btn-eraser');
            if (isEraserMode) {
                btn.classList.add('active'); btn.innerHTML = 'ğŸ§¹ æ©¡çš®æ“¦ (ON)'; document.body.classList.add('eraser-mode-active');
            } else {
                btn.classList.remove('active'); btn.innerHTML = 'ğŸ§¹ æ©¡çš®æ“¦ (OFF)'; document.body.classList.remove('eraser-mode-active');
            }
        }

        function clearTask(taskIndex, event) {
            if (!isEraserMode || isLocked) return;
            event.stopPropagation(); 
            const task = projectData.categories[activeCategoryIndex].groups[activeGroupIndex].tasks[taskIndex];
            let changed = false;
            task.subtasks.forEach(st => { if(st.done) { st.done = false; changed = true; } });
            if(changed) { localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData)); renderGroupView(); }
        }

        function renderProjectView() {
            document.getElementById('view-project').style.display = 'block';
            document.getElementById('view-category').style.display = 'none';
            document.getElementById('view-group').style.display = 'none';
            
            document.getElementById('btn-back').style.display = 'none';
            document.getElementById('btn-eraser').style.display = 'none'; 
            document.getElementById('page-title').innerText = projectData.projectName;

            if (isEraserMode) toggleEraserMode();

            const projStats = getProjectStats();
            let conicStops = [];
            const numCats = projectData.categories.length;
            
            if (numCats > 0) {
                const segmentSize = 100 / numCats; 
                const notchGap = 0.2; 
                
                // ç‚ºäº†ä¿æŒåŸæœ¬è¦–è¦ºé‚è¼¯ï¼Œé€™è£¡åšå€‹é˜²å‘†æ”¯æ´ä¸åŒæ•¸é‡çš„åˆ†é¡
                for (let i = 0; i < numCats; i++) {
                    const cat = projectData.categories[i];
                    const stats = getCategoryStats(cat);
                    
                    const startPercent = i * segmentSize;
                    const visualStart = startPercent + notchGap;
                    const availableSpace = segmentSize - notchGap;
                    const fillPercent = visualStart + (stats.percentage / 100) * availableSpace;
                    const endPercent = (i + 1) * segmentSize;
                    
                    conicStops.push(`#FFFFFF ${startPercent}% ${visualStart}%`);
                    conicStops.push(`${cat.color} ${visualStart}% ${fillPercent}%`);
                    conicStops.push(`#E0E0E0 ${fillPercent}% ${endPercent}%`);
                }
            } else {
                conicStops.push(`#E0E0E0 0% 100%`);
            }

            const positions = ['zone-left', 'zone-bottom', 'zone-right', 'zone-top']; 
            let zonesHTML = '';
            projectData.categories.forEach((cat, index) => {
                let posClass = positions[index % positions.length];
                zonesHTML += `
                    <div class="click-zone ${posClass}" onclick="openCategory(${index})">
                        <span class="zone-label" style="color: ${cat.color}">${cat.name}</span>
                    </div>
                `;
            });

            const projectPanel = document.getElementById('project-panel-content');
            projectPanel.innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #555;">å‹•ç•«æ•´é«”é€²åº¦</h2>
                <div class="ring-container">
                    <div class="big-progress-ring" style="background: conic-gradient(${conicStops.join(', ')})">
                        <span class="big-progress-text">${projStats.percentage}%</span>
                    </div>
                    ${zonesHTML}
                </div>
            `;

            const catContainer = document.getElementById('category-container');
            catContainer.innerHTML = '';
            projectData.categories.forEach((cat, index) => {
                const stats = getCategoryStats(cat);
                const card = document.createElement('div');
                card.className = 'category-card';
                card.onclick = () => openCategory(index);

                const infoText = cat.hasLayers ? `å…± ${cat.groups.length} å€‹ç« ç¯€ (${stats.total} é …ç´°ç¯€)` : `å…± ${(cat.groups[0]||{tasks:[]}).tasks.length} å€‹ä»»å‹™ (${stats.total} é …ç´°ç¯€)`;

                card.innerHTML = `
                    <div class="delete-btn" onclick="deleteCategory(${index}, event)" title="åˆªé™¤æ­¤å¤§åˆ†é¡">âœ•</div>
                    <div class="med-progress-ring" style="background: conic-gradient(${cat.color} ${stats.percentage}%, #E0E0E0 0%);">
                        <span class="med-progress-text" style="color: ${cat.color}">${stats.percentage}%</span>
                    </div>
                    <div class="centered-title-wrapper">
                        <div class="cat-title">${cat.name}</div>
                        <div class="edit-wrapper"><span class="edit-btn" onclick="renameCategory(${index}, event)" title="é‡æ–°å‘½å">âœï¸</span></div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 14px;">${infoText}</div>
                `;
                catContainer.appendChild(card);
            });
        }

        function renderCategoryView() {
            document.getElementById('view-project').style.display = 'none';
            document.getElementById('view-category').style.display = 'block';
            document.getElementById('view-group').style.display = 'none';

            if (isEraserMode) toggleEraserMode(); 
            document.getElementById('btn-eraser').style.display = 'none'; 
            
            const btnBack = document.getElementById('btn-back');
            btnBack.style.display = 'block'; btnBack.innerText = "â† è¿”å›å°ˆæ¡ˆç¸½è¦½"; btnBack.onclick = goBackToProject;

            const cat = projectData.categories[activeCategoryIndex];
            document.getElementById('page-title').innerText = cat.name;

            const stats = getCategoryStats(cat);
            document.getElementById('cat-detail-name').innerText = `${cat.name} æ•´é«”é€²åº¦`;
            document.getElementById('cat-detail-text').innerText = `${stats.percentage}%`;
            document.getElementById('cat-detail-fill').style.width = `${stats.percentage}%`;
            document.getElementById('cat-detail-fill').style.backgroundColor = cat.color;

            const groupContainer = document.getElementById('group-container');
            groupContainer.innerHTML = '';

            const addBtn = document.getElementById('add-group-btn');
            addBtn.onmouseover = () => { addBtn.style.borderColor = cat.color; addBtn.style.color = cat.color; addBtn.style.backgroundColor = cat.color + '10'; };
            addBtn.onmouseout = () => { addBtn.style.borderColor = '#cccccc'; addBtn.style.color = '#888888'; addBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; };

            cat.groups.forEach((grp, groupIndex) => {
                const gStats = getGroupStats(grp);
                const card = document.createElement('div');
                card.className = 'category-card';
                card.onclick = () => openGroup(groupIndex);

                card.innerHTML = `
                    <div class="delete-btn" onclick="deleteGroup(${groupIndex}, event)" title="åˆªé™¤æ­¤ç« ç¯€">âœ•</div>
                    <div class="med-progress-ring" style="background: conic-gradient(${cat.color} ${gStats.percentage}%, #E0E0E0 0%);">
                        <span class="med-progress-text" style="color: ${cat.color}">${gStats.percentage}%</span>
                    </div>
                    <div class="centered-title-wrapper">
                        <div class="cat-title">${grp.name}</div>
                        <div class="edit-wrapper"><span class="edit-btn" onclick="renameGroup(${groupIndex}, event)" title="é‡æ–°å‘½å">âœï¸</span></div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 14px;">å…± ${grp.tasks.length} å€‹ä»»å‹™ (${gStats.total} é …ç´°ç¯€)</div>
                `;
                groupContainer.appendChild(card);
            });
        }

        function renderGroupView() {
            document.getElementById('view-project').style.display = 'none';
            document.getElementById('view-category').style.display = 'none';
            document.getElementById('view-group').style.display = 'block';

            document.getElementById('btn-eraser').style.display = 'flex'; 

            const cat = projectData.categories[activeCategoryIndex];
            const grp = cat.groups[activeGroupIndex];
            const btnBack = document.getElementById('btn-back');
            btnBack.style.display = 'block';

            if (!cat.hasLayers) {
                btnBack.innerText = `â† è¿”å›å°ˆæ¡ˆç¸½è¦½`;
                btnBack.onclick = goBackToProject;
                document.getElementById('page-title').innerText = `${cat.name}`;
                document.getElementById('grp-detail-name').innerText = `${cat.name} æ•´é«”é€²åº¦`;
            } else {
                btnBack.innerText = `â† è¿”å› ${cat.name}`;
                btnBack.onclick = goBackToCategory;
                document.getElementById('page-title').innerText = `${cat.name} / ${grp.name}`;
                document.getElementById('grp-detail-name').innerText = `${grp.name} ç« ç¯€é€²åº¦`;
            }

            const stats = getGroupStats(grp);
            document.getElementById('grp-detail-text').innerText = `${stats.percentage}%`;
            document.getElementById('grp-detail-fill').style.width = `${stats.percentage}%`;
            document.getElementById('grp-detail-fill').style.backgroundColor = cat.color;

            const taskContainer = document.getElementById('task-container');
            taskContainer.innerHTML = '';

            const addBtn = document.getElementById('add-task-btn');
            addBtn.onmouseover = () => { addBtn.style.borderColor = cat.color; addBtn.style.color = cat.color; addBtn.style.backgroundColor = cat.color + '10'; };
            addBtn.onmouseout = () => { addBtn.style.borderColor = '#cccccc'; addBtn.style.color = '#888888'; addBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; };

            grp.tasks.forEach((task, taskIndex) => {
                const tStats = getTaskStats(task);
                const isCompleted = tStats.total > 0 && tStats.percentage === 100;

                const card = document.createElement('div');
                card.className = `task-card ${isCompleted ? 'card-completed' : ''}`;
                if(isCompleted) card.style.borderColor = cat.color;

                let subtasksHTML = task.subtasks.map((st, subIndex) => `
                    <label class="subtask-label">
                        <div style="display:flex; align-items:center;">
                            <input type="checkbox" class="subtask-checkbox" style="accent-color: ${cat.color}"
                                ${st.done ? 'checked' : ''} 
                                onchange="toggleSubtask(${taskIndex}, ${subIndex}, this)"> 
                            <span class="${st.done ? 'completed-text' : ''}">${st.name}</span>
                        </div>
                        <span class="edit-btn" onclick="renameSubtask(${taskIndex}, ${subIndex}, event)" title="é‡æ–°å‘½å">âœï¸</span>
                    </label>
                `).join('');

                const arrowIcon = task.expanded ? 'â–¼' : 'â–¶';

                card.innerHTML = `
                    <div class="eraser-overlay" onclick="clearTask(${taskIndex}, event)" title="é»æ“Šæ¸…é™¤æ­¤ä»»å‹™é€²åº¦"></div>
                    <div class="delete-btn" onclick="deleteTask(${taskIndex}, event)" title="åˆªé™¤æ­¤ä»»å‹™">âœ•</div>
                    <div class="task-header" onclick="toggleTask(${taskIndex})">
                        <div class="title-wrapper">
                            <span class="toggle-icon">${arrowIcon}</span>
                            <h3 class="task-title">${task.title}</h3>
                            <span class="edit-btn" onclick="renameTask(${taskIndex}, event)" title="é‡æ–°å‘½å">âœï¸</span>
                        </div>
                        <div class="progress-ring" style="background: conic-gradient(${cat.color} ${tStats.percentage}%, #E0E0E0 0%);">
                            <span class="progress-text">${tStats.percentage}%</span>
                        </div>
                    </div>
                    <div class="subtasks" style="display: ${task.expanded ? 'flex' : 'none'};">
                        ${subtasksHTML}
                    </div>
                `;
                taskContainer.appendChild(card);
            });
        }

        function renameCategory(index, event) {
            event.stopPropagation(); 
            if (isEraserMode || isLocked) return;
            const cat = projectData.categories[index];
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„å¤§åˆ†é¡åç¨±ï¼š", cat.name);
            if (newName && newName.trim() !== "") {
                cat.name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderProjectView();
            }
        }

        function renameGroup(groupIndex, event) {
            event.stopPropagation(); 
            if (isLocked) return;
            const cat = projectData.categories[activeCategoryIndex];
            const currentName = cat.groups[groupIndex].name;
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„ç« ç¯€åç¨±ï¼š", currentName);
            if (newName && newName.trim() !== "") {
                cat.groups[groupIndex].name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderCategoryView();
            }
        }
        function deleteGroup(groupIndex, event) {
            event.stopPropagation(); 
            if (isLocked) return;
            const cat = projectData.categories[activeCategoryIndex];
            const name = cat.groups[groupIndex].name;
            if (confirm(`ç¢ºå®šè¦åˆªé™¤æ•´å€‹ç« ç¯€ã€Œ${name}ã€å—ï¼Ÿ\nè£¡é¢çš„æ‰€æœ‰ä»»å‹™éƒ½æœƒä¸è¦‹ä¸”ç„¡æ³•å¾©åŸå–”ï¼`)) {
                cat.groups.splice(groupIndex, 1); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderCategoryView();
            }
        }
        function renameTask(taskIndex, event) {
            event.stopPropagation(); 
            if (isEraserMode || isLocked) return; 
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const currentName = grp.tasks[taskIndex].title;
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„ä»»å‹™åç¨±ï¼š", currentName);
            if (newName && newName.trim() !== "") {
                grp.tasks[taskIndex].title = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderGroupView();
            }
        }
        function renameSubtask(taskIndex, subIndex, event) {
            event.preventDefault(); event.stopPropagation(); 
            if (isEraserMode || isLocked) return;
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const currentName = grp.tasks[taskIndex].subtasks[subIndex].name;
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„ç´°é …åç¨±ï¼š", currentName);
            if (newName && newName.trim() !== "") {
                grp.tasks[taskIndex].subtasks[subIndex].name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderGroupView();
            }
        }
        function deleteTask(taskIndex, event) {
            event.stopPropagation(); 
            if (isLocked) return;
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const name = grp.tasks[taskIndex].title;
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ä»»å‹™ã€Œ${name}ã€å—ï¼Ÿ`)) {
                grp.tasks.splice(taskIndex, 1); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderGroupView();
            }
        }

        function addGroup() {
            if (isLocked) return;
            const cat = projectData.categories[activeCategoryIndex];
            const name = prompt("è«‹è¼¸å…¥æ–°ç« ç¯€åç¨± (ä¾‹å¦‚ S03)ï¼š", `æ–°ç« ç¯€ ${cat.groups.length + 1}`);
            if (!name) return; 

            let templateSubtasks = [{name: "å·¥ä½œç´°é …", done: false}];
            if (cat.groups.length > 0 && cat.groups[0].tasks.length > 0) {
                templateSubtasks = cat.groups[0].tasks[0].subtasks.map(st => ({ name: st.name, done: false }));
            }
            cat.groups.push({ name: name, tasks: [{ id: `t_${Date.now()}`, title: "æ–°ä»»å‹™", expanded: true, subtasks: templateSubtasks }] });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            renderCategoryView();
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
        function addTask() {
            if (isEraserMode || isLocked) return; 
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const taskName = prompt("è«‹è¼¸å…¥æ–°ä»»å‹™åç¨±ï¼š", `æ–°å¢ä»»å‹™ ${grp.tasks.length + 1}`);
            if (!taskName) return; 

            let templateSubtasks = [{name: "å·¥ä½œç´°é …", done: false}];
            if (grp.tasks.length > 0) {
                templateSubtasks = grp.tasks[0].subtasks.map(st => ({ name: st.name, done: false }));
            }
            grp.tasks.push({ id: `t_${Date.now()}`, title: taskName, expanded: true, subtasks: templateSubtasks });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            renderGroupView();
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function openCategory(index) {
            activeCategoryIndex = index;
            const cat = projectData.categories[index];
            
            if (!cat.hasLayers) {
                activeGroupIndex = 0; 
                renderGroupView();
            } else {
                activeGroupIndex = null;
                renderCategoryView();
            }
        }
        function openGroup(index) {
            activeGroupIndex = index;
            renderGroupView();
        }
        function goBackToProject() {
            activeCategoryIndex = null;
            activeGroupIndex = null;
            renderProjectView();
        }
        function goBackToCategory() {
            const cat = projectData.categories[activeCategoryIndex];
            cat.groups[activeGroupIndex].tasks.forEach(t => t.expanded = false);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            
            if (!cat.hasLayers) {
                goBackToProject();
            } else {
                activeGroupIndex = null;
                renderCategoryView();
            }
        }
        function toggleTask(taskIndex) {
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            grp.tasks[taskIndex].expanded = !grp.tasks[taskIndex].expanded;
            renderGroupView();
        }

        function toggleSubtask(taskIndex, subIndex, checkboxElem) {
            const cat = projectData.categories[activeCategoryIndex];
            const grp = cat.groups[activeGroupIndex];
            const task = grp.tasks[taskIndex];
            
            const wasTaskCompleted = getTaskStats(task).percentage === 100;
            const wasGrpCompleted = getGroupStats(grp).percentage === 100;
            const wasCatCompleted = getCategoryStats(cat).percentage === 100;
            
            task.subtasks[subIndex].done = !task.subtasks[subIndex].done;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));

            const isTaskNowCompleted = getTaskStats(task).percentage === 100;
            const isGrpNowCompleted = getGroupStats(grp).percentage === 100;
            const isCatNowCompleted = getCategoryStats(cat).percentage === 100;

            const rect = checkboxElem.getBoundingClientRect();
            const x = rect.left + (rect.width / 2);
            const y = rect.top + (rect.height / 2);

            if (!wasTaskCompleted && isTaskNowCompleted) { fireConfetti(x, y, 40, false); }
            if (!wasGrpCompleted && isGrpNowCompleted && cat.hasLayers) {
                setTimeout(() => { fireConfetti(window.innerWidth / 2, window.innerHeight / 2, 100, true); }, 300);
            }
            if (!wasCatCompleted && isCatNowCompleted) {
                setTimeout(() => { fireConfetti(window.innerWidth / 2, window.innerHeight / 2, 250, true); }, 600);
            }
            renderGroupView();
        }

        document.addEventListener('click', function(event) {
            if (activeGroupIndex === null) return; 
            const isClickInsideCard = event.target.closest('.task-card');
            const isClickInsideHeader = event.target.closest('.header-nav'); 
            const isClickInsideAddBtn = event.target.closest('.add-btn'); 

            if (!isClickInsideCard && !isClickInsideHeader && !isClickInsideAddBtn) {
                let changed = false;
                projectData.categories[activeCategoryIndex].groups[activeGroupIndex].tasks.forEach(task => {
                    if (task.expanded) { task.expanded = false; changed = true; }
                });
                if (changed) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                    renderGroupView();
                }
            }
        });

        function fireConfetti(x, y, particleCount, isHuge) {
            const colors = ['#FFC700', '#FF0000', '#2E3192', '#41BBC7', '#4CAF50', '#FF69B4', '#00FFFF'];
            for (let i = 0; i < particleCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                if (isHuge) { confetti.style.width = '15px'; confetti.style.height = '15px'; } 
                else { confetti.style.width = '10px'; confetti.style.height = '10px'; }
                document.body.appendChild(confetti);
                confetti.style.left = x + 'px'; confetti.style.top = y + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const angle = Math.random() * Math.PI * 2;
                const velocity = (isHuge ? 100 : 50) + Math.random() * (isHuge ? 250 : 150);
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity - (isHuge ? 150 : 80); 
                confetti.style.setProperty('--tx', `${tx}px`);
                confetti.style.setProperty('--ty', `${ty}px`);
                setTimeout(() => confetti.remove(), 1000);
            }
        }

        // åˆå§‹åŒ–
        renderRoadmap();
        renderProjectView();
        // ç¢ºä¿åˆå§‹æ™‚æ›´æ–°é–å®šç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ
        document.getElementById('btn-lock').innerText = isLocked ? 'ğŸ”’' : 'ğŸ”“';
    </script>
</body>
</html>
