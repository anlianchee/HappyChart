<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XXÊàÄÊÑõÁâ©Ë™û - Â∞àÊ°àÁÆ°ÁêÜ</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --category-color-1: #3498db; 
            --category-color-2: #9b59b6; 
            --category-color-3: #e74c3c; 
            --bg-color: #F4F7F6;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #333333;
            --text-muted: #888888;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('bg.png'); 
            background-size: cover;          
            background-position: center;     
            background-attachment: fixed;    
            color: var(--text-main);
            padding: 20px 20px;
            max-width: 1000px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        .header-nav { display: flex; align-items: center; margin-bottom: 20px; position: relative; flex-wrap: wrap; gap: 15px;}
        .back-btn {
            background: #FFFFFF; border: 2px solid #E0E0E0; padding: 8px 15px; margin-right: 15px;
            border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: all 0.2s; display: none; 
        }
        .back-btn:hover { background: #f0f0f0; transform: translateX(-3px); }
        
        .main-title-wrapper { display: flex; align-items: center; gap: 10px; }
        .main-title { font-size: 32px; margin: 0; font-weight: 800; text-shadow: 0 2px 4px rgba(255,255,255,0.8); }
        .header-edit-btn { font-size: 20px; cursor: pointer; opacity: 0; transition: 0.2s ease; }
        .main-title-wrapper:hover .header-edit-btn { opacity: 0.5; }
        .header-edit-btn:hover { opacity: 1 !important; transform: scale(1.1); }

        .roadmap-container {
            display: flex; align-items: center; margin-left: 20px;
            background: rgba(255, 255, 255, 0.6); padding: 5px 15px; border-radius: 30px; backdrop-filter: blur(5px);
        }
        .roadmap-node {
            display: flex; align-items: center; padding: 6px 14px; border-radius: 20px; 
            font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; user-select: none;
        }
        .roadmap-edit { font-size: 12px; margin-left: 6px; opacity: 0; transition: 0.2s; }
        .roadmap-delete { font-size: 10px; margin-left: 6px; opacity: 0; transition: 0.2s; color: #e74c3c; font-weight: bold; padding: 2px;}
        .roadmap-node:hover .roadmap-edit, .roadmap-node:hover .roadmap-delete { opacity: 0.6; }
        .roadmap-edit:hover, .roadmap-delete:hover { opacity: 1 !important; transform: scale(1.2); }
        
        .state-todo { background: #EEEEEE; color: #999; }
        .state-todo:hover { background: #E0E0E0; }
        .state-doing { 
            background: #E3F2FD; color: #0288D1; box-shadow: 0 0 0 2px #0288D1 inset;
            animation: breath 2s infinite ease-in-out;
        }
        .state-done { background: var(--primary-color); color: white; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4); }
        
        .roadmap-line { width: 25px; height: 3px; background: #EEEEEE; margin: 0 5px; transition: 0.3s; border-radius: 2px;}
        
        .roadmap-add-btn {
            display: flex; align-items: center; justify-content: center;
            width: 26px; height: 26px; border-radius: 50%; background: #EEEEEE; color: #888;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;
            margin-left: 10px; border: 2px dashed #cccccc;
        }
        .roadmap-add-btn:hover { background: #E0E0E0; border-color: #aaa; color: #555; transform: scale(1.1); }

        @keyframes breath {
            0% { box-shadow: 0 0 0 2px #0288D1 inset, 0 0 0 0 rgba(2, 136, 209, 0.4); }
            70% { box-shadow: 0 0 0 2px #0288D1 inset, 0 0 0 8px rgba(2, 136, 209, 0); }
            100% { box-shadow: 0 0 0 2px #0288D1 inset, 0 0 0 0 rgba(2, 136, 209, 0); }
        }

        .header-controls { margin-left: auto; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: flex-end;}

        /* Èõ≤Á´ØÂ≠òÊ™î/ËÆÄÂèñÊåâÈàïÊ®£Âºè */
        .cloud-btn {
            background: #FFFFFF; border: 2px solid #E0E0E0; padding: 8px 12px;
            border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 15px;
            color: #555; transition: all 0.3s; display: flex; align-items: center; gap: 6px;
        }
        .cloud-btn:hover:not(:disabled) { background: #f0f8ff; border-color: #3498db; color: #2980b9; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .cloud-btn:disabled { opacity: 0.6; cursor: wait; }

        .lock-btn {
            background: transparent; border: none; font-size: 22px; cursor: pointer;
            opacity: 0.5; transition: all 0.3s ease; padding: 5px; outline: none;
            filter: grayscale(0.8);
        }
        .lock-btn:hover { opacity: 0.9; transform: scale(1.1); filter: grayscale(0); }
        
        body.locked-mode .delete-btn,
        body.locked-mode .add-btn,
        body.locked-mode .roadmap-delete,
        body.locked-mode .roadmap-add-btn,
        body.locked-mode .edit-btn,
        body.locked-mode .header-edit-btn,
        body.locked-mode .roadmap-edit { display: none !important; }

        .eraser-btn {
            background: #FFFFFF; border: 2px solid #E0E0E0; padding: 8px 15px;
            border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px;
            color: #888; transition: all 0.3s; display: none; align-items: center; gap: 8px;
        }
        .eraser-btn:hover { border-color: #ff9999; color: #e74c3c; }
        .eraser-btn.active { background: #ffebee; border-color: #e74c3c; color: #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }

        .project-overview-panel {
            background: var(--card-bg); border-radius: 20px; padding: 30px;
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px;
            display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(10px);
        }
        
        .ring-container { position: relative; width: 180px; height: 180px; margin: 30px auto 60px auto; display: flex; justify-content: center; align-items: center; }
        .click-zone { position: absolute; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 10; padding: 10px 15px; }
        .zone-label { font-size: 24px; font-weight: 900; pointer-events: none; white-space: nowrap; }

        .zone-left { right: 100%; top: 50%; transform: translate(-50px, -50%); }
        .zone-right { left: 100%; top: 50%; transform: translate(50px, -50%); }
        .zone-bottom { top: 100%; left: 50%; transform: translate(-50%, 25px); }
        .zone-top { bottom: 100%; left: 50%; transform: translate(-50%, -25px); }

        .big-progress-ring {
            width: 180px; height: 180px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            background: conic-gradient(#E0E0E0 0%, #E0E0E0 100%); 
            position: relative; transition: background 1s ease-out; z-index: 5; 
        }
        .big-progress-ring::before { content: ""; position: absolute; width: 145px; height: 145px; background-color: #FFFFFF; border-radius: 50%; }
        .big-progress-text { position: relative; font-size: 40px; font-weight: 900; color: #333; z-index: 100; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        .category-card {
            background: var(--card-bg); border-radius: 20px; padding: 25px 20px; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; backdrop-filter: blur(5px);
            transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; align-items: center; gap: 12px;
        }
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .category-card:hover .edit-btn, .category-card:hover .delete-btn { opacity: 0.5; } 
        
        .cat-title { font-size: 22px; font-weight: bold; }
        .med-progress-ring {
            width: 100px; height: 100px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            position: relative; transition: background 0.8s;
        }
        .med-progress-ring::before { content: ""; position: absolute; width: 80px; height: 80px; background-color: #FFFFFF; border-radius: 50%; }
        .med-progress-text { position: relative; font-size: 20px; font-weight: bold; }

        .centered-title-wrapper { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; }
        .centered-title-wrapper::before { content: ""; } 
        .centered-title-wrapper .cat-title { text-align: center; }
        .centered-title-wrapper .edit-wrapper { justify-self: start; padding-left: 8px; } 

        .task-card {
            background: var(--card-bg); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; overflow: hidden; border: 2px solid transparent; transition: all 0.3s ease; position: relative;
        }
        .task-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; cursor: pointer; user-select: none; }
        .task-header:hover { background-color: rgba(250, 250, 250, 0.5); }
        .title-wrapper { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .task-title { font-size: 18px; font-weight: bold; margin: 0; color: #333; }
        
        .progress-ring {
            width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            position: relative; transition: background 0.6s;
        }
        .progress-ring::before { content: ""; position: absolute; width: 38px; height: 38px; background-color: #FFFFFF; border-radius: 50%; transition: background-color 0.3s; }
        .progress-text { position: relative; font-weight: bold; font-size: 13px; }

        .subtasks { display: flex; flex-direction: column; gap: 10px; padding: 0 25px 25px 25px; border-top: 1px solid rgba(238, 238, 238, 0.5); }
        .subtask-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 15px; padding: 6px; border-radius: 8px; margin-top: 5px; }
        .subtask-label:hover { background-color: rgba(240, 240, 240, 0.8); }
        .subtask-checkbox { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; }
        .completed-text { text-decoration: line-through; color: var(--text-muted); }

        .card-completed { background-color: rgba(240, 255, 240, 0.95); border: 2px solid var(--primary-color); box-shadow: 0 0 20px rgba(76, 175, 80, 0.2); }
        .card-completed .task-header { background-color: transparent; }
        .card-completed .progress-ring::before { background-color: #F0FFF0; }

        .delete-btn {
            position: absolute; top: 8px; right: 10px; font-size: 12px; color: rgba(0, 0, 0, 0.2);
            background: transparent; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 10; transition: all 0.2s; opacity: 0;
        }
        .delete-btn:hover { color: #ffffff; background-color: rgba(231, 76, 60, 0.8); opacity: 1 !important; }
        .task-card:hover .delete-btn { opacity: 0.5; }

        .add-btn {
            width: 100%; margin-top: 30px; padding: 18px; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px);
            border: 2px dashed #cccccc; border-radius: 15px; color: #888888;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-align: center;
        }
        .add-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background-color: rgba(240, 255, 240, 0.9); transform: translateY(-2px); }

        .edit-btn { font-size: 14px; cursor: pointer; opacity: 0; transition: all 0.2s ease; padding: 4px; border-radius: 4px; }
        .centered-title-wrapper:hover .edit-btn, .title-wrapper:hover .edit-btn, .subtask-label:hover .edit-btn { opacity: 0.5; }
        .edit-btn:hover { opacity: 1 !important; background-color: #e0e0e0; transform: scale(1.1); }

        .eraser-mode-active, .eraser-mode-active * { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="%23ffcccc" stroke="%23e74c3c" stroke-width="2"><path d="M20 20H7L3 16C2.5 15.5 2.5 14.5 3 14L13 4C13.5 3.5 14.5 3.5 15 4L20 9C20.5 9.5 20.5 10.5 20 11L11 20H20V20Z"/></svg>') 4 20, crosshair !important; }
        .eraser-overlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 50; }
        .eraser-mode-active .eraser-overlay { display: block; }
        .eraser-mode-active .task-card:hover { border-color: #ff9999; background-color: #fffafa; }

        .confetti { position: fixed; border-radius: 50%; pointer-events: none; z-index: 99999; animation: burst 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes burst { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        #view-project { display: block; }
        #view-category { display: none; }
        #view-group { display: none; }
        
        .top-progress-container { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 20px 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="locked-mode">

    <div class="header-nav">
        <button class="back-btn" id="btn-back">‚Üê ËøîÂõû</button>
        <div class="main-title-wrapper">
            <h1 class="main-title" id="page-title">XXÊàÄÊÑõÁâ©Ë™û</h1>
            <span class="header-edit-btn" onclick="renameProject(event)" title="‰øÆÊîπÂ∞àÊ°àÂêçÁ®±">‚úèÔ∏è</span>
        </div>
        
        <div id="roadmap-container" class="roadmap-container"></div>
        
        <div class="header-controls">
            <button class="cloud-btn" id="btn-load-cloud" onclick="loadFromCloud()">‚òÅÔ∏è ËÆÄÂèñÈÄ≤Â∫¶</button>
            <button class="cloud-btn" id="btn-save-cloud" onclick="saveToCloud()">üíæ Â≠òÊ™îËá≥Èõ≤Á´Ø</button>
            
            <button class="eraser-btn" id="btn-eraser" onclick="toggleEraserMode()">üßπ Ê©°ÁöÆÊì¶ (OFF)</button>
            <button id="btn-lock" class="lock-btn" onclick="toggleLockMode()" title="ÂàáÊèõÁ∑®ËºØÊ®°Âºè">üîí</button>
        </div>
    </div>

    <div id="view-project">
        <div class="project-overview-panel" id="project-panel-content"></div>
        <div class="grid-container" id="category-container"></div>
    </div>

    <div id="view-category">
        <div class="top-progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <strong style="font-size: 18px;" id="cat-detail-name">ÂàÜÈ°ûÈÄ≤Â∫¶</strong>
                <strong id="cat-detail-text">0%</strong>
            </div>
            <div style="width: 100%; height: 20px; background: #E0E0E0; border-radius: 10px; overflow: hidden;">
                <div id="cat-detail-fill" style="height: 100%; background: var(--primary-color); width: 0%; transition: 0.5s;"></div>
            </div>
        </div>
        <div class="grid-container" id="group-container"></div>
        <button class="add-btn" id="add-group-btn" onclick="addGroup()">+ Êñ∞Â¢ûÁ´†ÁØÄ / Áæ§ÁµÑ</button>
    </div>

    <div id="view-group">
        <div class="top-progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <strong style="font-size: 18px;" id="grp-detail-name">Á´†ÁØÄ/‰ªªÂãô ÈÄ≤Â∫¶</strong>
                <strong id="grp-detail-text">0%</strong>
            </div>
            <div style="width: 100%; height: 20px; background: #E0E0E0; border-radius: 10px; overflow: hidden;">
                <div id="grp-detail-fill" style="height: 100%; background: var(--primary-color); width: 0%; transition: 0.5s;"></div>
            </div>
        </div>
        <div class="grid-container" id="task-container"></div>
        <button class="add-btn" id="add-task-btn" onclick="addTask()">+ Êñ∞Â¢û‰ªªÂãô</button>
    </div>

    <script>
        // ‰Ω†ÂâõÊâçÂª∫Á´ãÁöÑ Google Apps Script Â∞àÂ±¨ API Á∂≤ÂùÄÔºÅ
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyR38ijXFcnBWeIUyG4FS02rx4fziIx9huDm9xA8fT8yMzzwkYVJuEtyU0sUoylOUJ-JQ/exec';
        
        const STORAGE_KEY = 'IslandProject_Data_v34'; 
        let isLocked = true; 

        const initData = {
            projectName: "XXÊàÄÊÑõÁâ©Ë™û",
            roadmap: [
                { name: "ÁØÄÈªû 1", state: "done" },   
                { name: "ÁØÄÈªû 2", state: "doing" },
                { name: "ÁØÄÈªû 3", state: "todo" }
            ],
            categories: [
                {
                    id: "cat_gameplay", name: "Game play", color: "var(--category-color-1)", hasLayers: true,
                    groups: [
                        { name: "IdleÂãïÁï´", tasks: Array.from({length: 2}, (_, i) => ({ id: `idle${i}`, title: `Idle ${i+1}`, expanded: false, subtasks: [ {name: "Blocking", done: false}, {name: "Spline", done: false}, {name: "Polish", done: false}, {name: "Ëº∏Âá∫", done: false} ] })) },
                        { name: "ActÂãïÁï´", tasks: Array.from({length: 2}, (_, i) => ({ id: `act${i}`, title: `Act ${i+1}`, expanded: false, subtasks: [ {name: "Blocking", done: false}, {name: "Spline", done: false}, {name: "Polish", done: false}, {name: "Ëº∏Âá∫", done: false} ] })) }
                    ]
                },
                {
                    id: "cat_cutscene", name: "ÂäáÊÉÖÂãïÁï´", color: "var(--category-color-2)", hasLayers: true, 
                    groups: [
                        { name: "S01", tasks: Array.from({length: 6}, (_, i) => ({ id: `s01c${String(i+1).padStart(2, '0')}`, title: `S01C${String(i+1).padStart(2, '0')}`, expanded: false, subtasks: [ {name: "Blocking", done: false}, {name: "Spline", done: false}, {name: "Polish", done: false}, {name: "Render Ëº∏Âá∫", done: false} ] })) }
                    ]
                },
                {
                    id: "cat_h", name: "Á¥ÑÊúÉÂãïÁï´", color: "var(--category-color-3)", hasLayers: false,
                    groups: [
                        { name: "È†êË®≠Áæ§ÁµÑ", tasks: Array.from({length: 5}, (_, i) => ({ id: `h${i}`, title: `Á¥ÑÊúÉ Scene ${i+1}`, expanded: false, subtasks: [ {name: "keypose", done: false}, {name: "idle_breath_loop", done: false}, {name: "start", done: false}, {name: "slow_loop", done: false}, {name: "high_loop", done: false}, {name: "end", done: false}, {name: "end_breath_loop", done: false}, {name: "Êï¥ÁêÜÊ™îÊ°à", done: false}, {name: "Ëº∏Âá∫unityÊ™¢Êü•", done: false} ] })) }
                    ]
                }
            ]
        };

        let projectData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initData;
        let activeCategoryIndex = null; 
        let activeGroupIndex = null; 
        let isEraserMode = false; 

        // ==========================================
        // ‚òÅÔ∏è Èõ≤Á´ØÂêåÊ≠•ÂäüËÉΩÊ†∏ÂøÉÈÇèËºØ
        // ==========================================
        async function saveToCloud() {
            const btn = document.getElementById('btn-save-cloud');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ ËôïÁêÜ‰∏≠...';
            btn.disabled = true;

            try {
                // ‰ΩøÁî® fetch Â∞áË≥áÊñôÁôºÈÄÅÂà∞ Google Ë©¶ÁÆóË°®
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(projectData),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' } // ÈÅøÂÖçË∑®Á∂≤ÂüüÂïèÈ°åÁöÑÁâπÊÆäË®≠ÂÆö
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    btn.innerHTML = '‚úÖ Â≠òÊ™îÊàêÂäüÔºÅ';
                    setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error("Èõ≤Á´ØÂ≠òÊ™îÈåØË™§Ôºö", error);
                alert("Èõ≤Á´ØÂ≠òÊ™îÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ");
                btn.innerHTML = '‚ùå Â≠òÊ™îÂ§±Êïó';
                setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
            }
        }

        async function loadFromCloud() {
            if (!confirm("Á¢∫ÂÆöË¶ÅÂæûÈõ≤Á´ØËÆÄÂèñÈÄ≤Â∫¶ÂóéÔºüÈÄôÊúÉË¶ÜËìãÊéâ‰Ω†ÁõÆÂâçÁï´Èù¢‰∏äÁöÑÁãÄÊÖãÂñîÔºÅ")) return;

            const btn = document.getElementById('btn-load-cloud');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ ‰∏ãËºâ‰∏≠...';
            btn.disabled = true;

            try {
                // ËÆÄÂèñ Google Ë©¶ÁÆóË°®ÁöÑË≥áÊñô
                const response = await fetch(GAS_URL);
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    projectData = result.data;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData)); // ÂêåÊ≠•ÂØ´ÂÖ•Êú¨Ê©ü
                    
                    // ÈÄÄÂõûÈ¶ñÈ†Å‰∏¶ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÁï´Èù¢
                    activeCategoryIndex = null;
                    activeGroupIndex = null;
                    renderRoadmap();
                    renderProjectView();
                    
                    btn.innerHTML = '‚úÖ ËÆÄÂèñÂÆåÁï¢ÔºÅ';
                    setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
                } else if (result.status === 'empty') {
                    alert("Èõ≤Á´ØË≥áÊñôÂ∫´ÁõÆÂâçÊòØÁ©∫ÁöÑÔºÅË´ãÂÖàÈªûÊìä„ÄåÂ≠òÊ™îËá≥Èõ≤Á´Ø„Äç‰∏äÂÇ≥‰∏ÄÊ¨°ÈÄ≤Â∫¶„ÄÇ");
                    btn.innerHTML = originalText; btn.disabled = false;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error("Èõ≤Á´ØËÆÄÂèñÈåØË™§Ôºö", error);
                alert("Èõ≤Á´ØËÆÄÂèñÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ");
                btn.innerHTML = '‚ùå ËÆÄÂèñÂ§±Êïó';
                setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
            }
        }
        // ==========================================

        function toggleLockMode() {
            isLocked = !isLocked;
            document.body.classList.toggle('locked-mode', isLocked);
            document.getElementById('btn-lock').innerText = isLocked ? 'üîí' : 'üîì';
            if (isLocked && isEraserMode) toggleEraserMode(); 
        }

        function renameProject(event) {
            event.stopPropagation();
            if (isLocked) return;
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÂ∞àÊ°àÂêçÁ®±Ôºö", projectData.projectName);
            if (newName && newName.trim() !== "") {
                projectData.projectName = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                document.getElementById('page-title').innerText = projectData.projectName;
            }
        }

        function addRoadmapNode() {
            if (isLocked) return;
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÈöéÊÆµÂêçÁ®±Ôºö", `Êñ∞ÈöéÊÆµ ${projectData.roadmap.length + 1}`);
            if (newName && newName.trim() !== "") {
                projectData.roadmap.push({ name: newName.trim(), state: "todo" });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderRoadmap();
            }
        }

        function deleteRoadmapNode(index, event) {
            event.stopPropagation();
            if (isLocked) return;
            const nodeName = projectData.roadmap[index].name;
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄ≤Â∫¶ÁØÄÈªû„Äå${nodeName}„ÄçÂóéÔºü`)) {
                projectData.roadmap.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderRoadmap();
            }
        }

        function deleteCategory(index, event) {
            event.stopPropagation();
            if (isLocked) return;
            const catName = projectData.categories[index].name;
            if (confirm(`‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÂà™Èô§Êï¥ÂÄãÂ§ßÂàÜÈ°û„Äå${catName}„ÄçÂóéÔºü\nË£°Èù¢ÁöÑÊâÄÊúâÁ´†ÁØÄÂíå‰ªªÂãôÈÉΩÊúÉ‰∏Ä‰ΩµÊ∂àÂ§±‰∏îÁÑ°Ê≥ïÂæ©ÂéüÂñîÔºÅ`)) {
                projectData.categories.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderProjectView();
            }
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmap-container');
            container.innerHTML = '';
            
            projectData.roadmap.forEach((node, index) => {
                const pill = document.createElement('div');
                pill.className = `roadmap-node state-${node.state}`;
                pill.onclick = () => toggleRoadmapNode(index);
                
                let icon = '';
                if (node.state === 'done') icon = '‚úî ';
                if (node.state === 'doing') icon = '‚ñ∂ ';
                
                pill.innerHTML = `
                    <span>${icon}${node.name}</span>
                    <span class="roadmap-edit" onclick="renameRoadmapNode(${index}, event)" title="ÈáçÊñ∞ÂëΩÂêç">‚úèÔ∏è</span>
                    <span class="roadmap-delete" onclick="deleteRoadmapNode(${index}, event)" title="Âà™Èô§ÁØÄÈªû">‚úï</span>
                `;
                container.appendChild(pill);
                
                if (index < projectData.roadmap.length - 1) {
                    const line = document.createElement('div');
                    line.className = 'roadmap-line';
                    if (node.state === 'done') line.style.background = 'var(--primary-color)';
                    container.appendChild(line);
                }
            });

            const addBtn = document.createElement('div');
            addBtn.className = 'roadmap-add-btn';
            addBtn.innerText = '+';
            addBtn.onclick = addRoadmapNode;
            addBtn.title = 'Êñ∞Â¢ûÈÄ≤Â∫¶ÁØÄÈªû';
            container.appendChild(addBtn);
        }

        function toggleRoadmapNode(index) {
            if (isEraserMode || isLocked) return;
            const states = ['todo', 'doing', 'done'];
            const currentState = projectData.roadmap[index].state;
            let nextIndex = (states.indexOf(currentState) + 1) % states.length;
            projectData.roadmap[index].state = states[nextIndex];
            
            if (states[nextIndex] === 'done') {
                const nodes = document.querySelectorAll('.roadmap-node');
                const rect = nodes[index].getBoundingClientRect();
                fireConfetti(rect.left + rect.width/2, rect.top + rect.height/2, 20, false);
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            renderRoadmap();
        }

        function renameRoadmapNode(index, event) {
            event.stopPropagation(); 
            if (isEraserMode || isLocked) return;
            const currentName = projectData.roadmap[index].name;
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑË∑ØÁ∑öÂúñÁØÄÈªûÂêçÁ®±Ôºö", currentName);
            if (newName && newName.trim() !== "") {
                projectData.roadmap[index].name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderRoadmap();
            }
        }

        function getTaskStats(task) {
            const total = task.subtasks.length;
            const done = task.subtasks.filter(st => st.done).length;
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }
        function getGroupStats(group) {
            let total = 0, done = 0;
            group.tasks.forEach(t => { const s = getTaskStats(t); total += s.total; done += s.done; });
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }
        function getCategoryStats(category) {
            let total = 0, done = 0;
            category.groups.forEach(g => { const s = getGroupStats(g); total += s.total; done += s.done; });
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }
        function getProjectStats() {
            let total = 0, done = 0;
            projectData.categories.forEach(c => { const s = getCategoryStats(c); total += s.total; done += s.done; });
            return { total, done, percentage: total ? Math.round((done/total)*100) : 0 };
        }

        function toggleEraserMode() {
            if (isLocked) return; 
            isEraserMode = !isEraserMode;
            const btn = document.getElementById('btn-eraser');
            if (isEraserMode) {
                btn.classList.add('active'); btn.innerHTML = 'üßπ Ê©°ÁöÆÊì¶ (ON)'; document.body.classList.add('eraser-mode-active');
            } else {
                btn.classList.remove('active'); btn.innerHTML = 'üßπ Ê©°ÁöÆÊì¶ (OFF)'; document.body.classList.remove('eraser-mode-active');
            }
        }

        function clearTask(taskIndex, event) {
            if (!isEraserMode || isLocked) return;
            event.stopPropagation(); 
            const task = projectData.categories[activeCategoryIndex].groups[activeGroupIndex].tasks[taskIndex];
            let changed = false;
            task.subtasks.forEach(st => { if(st.done) { st.done = false; changed = true; } });
            if(changed) { localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData)); renderGroupView(); }
        }

        function renderProjectView() {
            document.getElementById('view-project').style.display = 'block';
            document.getElementById('view-category').style.display = 'none';
            document.getElementById('view-group').style.display = 'none';
            
            document.getElementById('btn-back').style.display = 'none';
            document.getElementById('btn-eraser').style.display = 'none'; 
            document.getElementById('page-title').innerText = projectData.projectName;

            if (isEraserMode) toggleEraserMode();

            const projStats = getProjectStats();
            let conicStops = [];
            const numCats = projectData.categories.length;
            
            if (numCats > 0) {
                const segmentSize = 100 / numCats; 
                const notchGap = 0.2; 
                
                for (let i = 0; i < numCats; i++) {
                    const cat = projectData.categories[i];
                    const stats = getCategoryStats(cat);
                    
                    const startPercent = i * segmentSize;
                    const visualStart = startPercent + notchGap;
                    const availableSpace = segmentSize - notchGap;
                    const fillPercent = visualStart + (stats.percentage / 100) * availableSpace;
                    const endPercent = (i + 1) * segmentSize;
                    
                    conicStops.push(`#FFFFFF ${startPercent}% ${visualStart}%`);
                    conicStops.push(`${cat.color} ${visualStart}% ${fillPercent}%`);
                    conicStops.push(`#E0E0E0 ${fillPercent}% ${endPercent}%`);
                }
            } else {
                conicStops.push(`#E0E0E0 0% 100%`);
            }

            const positions = ['zone-left', 'zone-bottom', 'zone-right', 'zone-top']; 
            let zonesHTML = '';
            projectData.categories.forEach((cat, index) => {
                let posClass = positions[index % positions.length];
                zonesHTML += `
                    <div class="click-zone ${posClass}" onclick="openCategory(${index})">
                        <span class="zone-label" style="color: ${cat.color}">${cat.name}</span>
                    </div>
                `;
            });

            const projectPanel = document.getElementById('project-panel-content');
            projectPanel.innerHTML = `
                <h2 style="margin: 0 0 10px 0; color: #555;">ÂãïÁï´Êï¥È´îÈÄ≤Â∫¶</h2>
                <div class="ring-container">
                    <div class="big-progress-ring" style="background: conic-gradient(${conicStops.join(', ')})">
                        <span class="big-progress-text">${projStats.percentage}%</span>
                    </div>
                    ${zonesHTML}
                </div>
            `;

            const catContainer = document.getElementById('category-container');
            catContainer.innerHTML = '';
            projectData.categories.forEach((cat, index) => {
                const stats = getCategoryStats(cat);
                const card = document.createElement('div');
                card.className = 'category-card';
                card.onclick = () => openCategory(index);

                const infoText = cat.hasLayers ? `ÂÖ± ${cat.groups.length} ÂÄãÁ´†ÁØÄ (${stats.total} È†ÖÁ¥∞ÁØÄ)` : `ÂÖ± ${(cat.groups[0]||{tasks:[]}).tasks.length} ÂÄã‰ªªÂãô (${stats.total} È†ÖÁ¥∞ÁØÄ)`;

                card.innerHTML = `
                    <div class="delete-btn" onclick="deleteCategory(${index}, event)" title="Âà™Èô§Ê≠§Â§ßÂàÜÈ°û">‚úï</div>
                    <div class="med-progress-ring" style="background: conic-gradient(${cat.color} ${stats.percentage}%, #E0E0E0 0%);">
                        <span class="med-progress-text" style="color: ${cat.color}">${stats.percentage}%</span>
                    </div>
                    <div class="centered-title-wrapper">
                        <div class="cat-title">${cat.name}</div>
                        <div class="edit-wrapper"><span class="edit-btn" onclick="renameCategory(${index}, event)" title="ÈáçÊñ∞ÂëΩÂêç">‚úèÔ∏è</span></div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 14px;">${infoText}</div>
                `;
                catContainer.appendChild(card);
            });
        }

        function renderCategoryView() {
            document.getElementById('view-project').style.display = 'none';
            document.getElementById('view-category').style.display = 'block';
            document.getElementById('view-group').style.display = 'none';

            if (isEraserMode) toggleEraserMode(); 
            document.getElementById('btn-eraser').style.display = 'none'; 
            
            const btnBack = document.getElementById('btn-back');
            btnBack.style.display = 'block'; btnBack.innerText = "‚Üê ËøîÂõûÂ∞àÊ°àÁ∏ΩË¶Ω"; btnBack.onclick = goBackToProject;

            const cat = projectData.categories[activeCategoryIndex];
            document.getElementById('page-title').innerText = cat.name;

            const stats = getCategoryStats(cat);
            document.getElementById('cat-detail-name').innerText = `${cat.name} Êï¥È´îÈÄ≤Â∫¶`;
            document.getElementById('cat-detail-text').innerText = `${stats.percentage}%`;
            document.getElementById('cat-detail-fill').style.width = `${stats.percentage}%`;
            document.getElementById('cat-detail-fill').style.backgroundColor = cat.color;

            const groupContainer = document.getElementById('group-container');
            groupContainer.innerHTML = '';

            const addBtn = document.getElementById('add-group-btn');
            addBtn.onmouseover = () => { addBtn.style.borderColor = cat.color; addBtn.style.color = cat.color; addBtn.style.backgroundColor = cat.color + '10'; };
            addBtn.onmouseout = () => { addBtn.style.borderColor = '#cccccc'; addBtn.style.color = '#888888'; addBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; };

            cat.groups.forEach((grp, groupIndex) => {
                const gStats = getGroupStats(grp);
                const card = document.createElement('div');
                card.className = 'category-card';
                card.onclick = () => openGroup(groupIndex);

                card.innerHTML = `
                    <div class="delete-btn" onclick="deleteGroup(${groupIndex}, event)" title="Âà™Èô§Ê≠§Á´†ÁØÄ">‚úï</div>
                    <div class="med-progress-ring" style="background: conic-gradient(${cat.color} ${gStats.percentage}%, #E0E0E0 0%);">
                        <span class="med-progress-text" style="color: ${cat.color}">${gStats.percentage}%</span>
                    </div>
                    <div class="centered-title-wrapper">
                        <div class="cat-title">${grp.name}</div>
                        <div class="edit-wrapper"><span class="edit-btn" onclick="renameGroup(${groupIndex}, event)" title="ÈáçÊñ∞ÂëΩÂêç">‚úèÔ∏è</span></div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 14px;">ÂÖ± ${grp.tasks.length} ÂÄã‰ªªÂãô (${gStats.total} È†ÖÁ¥∞ÁØÄ)</div>
                `;
                groupContainer.appendChild(card);
            });
        }

        function renderGroupView() {
            document.getElementById('view-project').style.display = 'none';
            document.getElementById('view-category').style.display = 'none';
            document.getElementById('view-group').style.display = 'block';

            document.getElementById('btn-eraser').style.display = 'flex'; 

            const cat = projectData.categories[activeCategoryIndex];
            const grp = cat.groups[activeGroupIndex];
            const btnBack = document.getElementById('btn-back');
            btnBack.style.display = 'block';

            if (!cat.hasLayers) {
                btnBack.innerText = `‚Üê ËøîÂõûÂ∞àÊ°àÁ∏ΩË¶Ω`;
                btnBack.onclick = goBackToProject;
                document.getElementById('page-title').innerText = `${cat.name}`;
                document.getElementById('grp-detail-name').innerText = `${cat.name} Êï¥È´îÈÄ≤Â∫¶`;
            } else {
                btnBack.innerText = `‚Üê ËøîÂõû ${cat.name}`;
                btnBack.onclick = goBackToCategory;
                document.getElementById('page-title').innerText = `${cat.name} / ${grp.name}`;
                document.getElementById('grp-detail-name').innerText = `${grp.name} Á´†ÁØÄÈÄ≤Â∫¶`;
            }

            const stats = getGroupStats(grp);
            document.getElementById('grp-detail-text').innerText = `${stats.percentage}%`;
            document.getElementById('grp-detail-fill').style.width = `${stats.percentage}%`;
            document.getElementById('grp-detail-fill').style.backgroundColor = cat.color;

            const taskContainer = document.getElementById('task-container');
            taskContainer.innerHTML = '';

            const addBtn = document.getElementById('add-task-btn');
            addBtn.onmouseover = () => { addBtn.style.borderColor = cat.color; addBtn.style.color = cat.color; addBtn.style.backgroundColor = cat.color + '10'; };
            addBtn.onmouseout = () => { addBtn.style.borderColor = '#cccccc'; addBtn.style.color = '#888888'; addBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; };

            grp.tasks.forEach((task, taskIndex) => {
                const tStats = getTaskStats(task);
                const isCompleted = tStats.total > 0 && tStats.percentage === 100;

                const card = document.createElement('div');
                card.className = `task-card ${isCompleted ? 'card-completed' : ''}`;
                if(isCompleted) card.style.borderColor = cat.color;

                let subtasksHTML = task.subtasks.map((st, subIndex) => `
                    <label class="subtask-label">
                        <div style="display:flex; align-items:center;">
                            <input type="checkbox" class="subtask-checkbox" style="accent-color: ${cat.color}"
                                ${st.done ? 'checked' : ''} 
                                onchange="toggleSubtask(${taskIndex}, ${subIndex}, this)"> 
                            <span class="${st.done ? 'completed-text' : ''}">${st.name}</span>
                        </div>
                        <span class="edit-btn" onclick="renameSubtask(${taskIndex}, ${subIndex}, event)" title="ÈáçÊñ∞ÂëΩÂêç">‚úèÔ∏è</span>
                    </label>
                `).join('');

                const arrowIcon = task.expanded ? '‚ñº' : '‚ñ∂';

                card.innerHTML = `
                    <div class="eraser-overlay" onclick="clearTask(${taskIndex}, event)" title="ÈªûÊìäÊ∏ÖÈô§Ê≠§‰ªªÂãôÈÄ≤Â∫¶"></div>
                    <div class="delete-btn" onclick="deleteTask(${taskIndex}, event)" title="Âà™Èô§Ê≠§‰ªªÂãô">‚úï</div>
                    <div class="task-header" onclick="toggleTask(${taskIndex})">
                        <div class="title-wrapper">
                            <span class="toggle-icon">${arrowIcon}</span>
                            <h3 class="task-title">${task.title}</h3>
                            <span class="edit-btn" onclick="renameTask(${taskIndex}, event)" title="ÈáçÊñ∞ÂëΩÂêç">‚úèÔ∏è</span>
                        </div>
                        <div class="progress-ring" style="background: conic-gradient(${cat.color} ${tStats.percentage}%, #E0E0E0 0%);">
                            <span class="progress-text">${tStats.percentage}%</span>
                        </div>
                    </div>
                    <div class="subtasks" style="display: ${task.expanded ? 'flex' : 'none'};">
                        ${subtasksHTML}
                    </div>
                `;
                taskContainer.appendChild(card);
            });
        }

        function renameCategory(index, event) {
            event.stopPropagation(); 
            if (isEraserMode || isLocked) return;
            const cat = projectData.categories[index];
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÂ§ßÂàÜÈ°ûÂêçÁ®±Ôºö", cat.name);
            if (newName && newName.trim() !== "") {
                cat.name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderProjectView();
            }
        }

        function renameGroup(groupIndex, event) {
            event.stopPropagation(); 
            if (isLocked) return;
            const cat = projectData.categories[activeCategoryIndex];
            const currentName = cat.groups[groupIndex].name;
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÁ´†ÁØÄÂêçÁ®±Ôºö", currentName);
            if (newName && newName.trim() !== "") {
                cat.groups[groupIndex].name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderCategoryView();
            }
        }
        function deleteGroup(groupIndex, event) {
            event.stopPropagation(); 
            if (isLocked) return;
            const cat = projectData.categories[activeCategoryIndex];
            const name = cat.groups[groupIndex].name;
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Êï¥ÂÄãÁ´†ÁØÄ„Äå${name}„ÄçÂóéÔºü\nË£°Èù¢ÁöÑÊâÄÊúâ‰ªªÂãôÈÉΩÊúÉ‰∏çË¶ã‰∏îÁÑ°Ê≥ïÂæ©ÂéüÂñîÔºÅ`)) {
                cat.groups.splice(groupIndex, 1); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderCategoryView();
            }
        }
        function renameTask(taskIndex, event) {
            event.stopPropagation(); 
            if (isEraserMode || isLocked) return; 
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const currentName = grp.tasks[taskIndex].title;
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑ‰ªªÂãôÂêçÁ®±Ôºö", currentName);
            if (newName && newName.trim() !== "") {
                grp.tasks[taskIndex].title = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderGroupView();
            }
        }
        function renameSubtask(taskIndex, subIndex, event) {
            event.preventDefault(); event.stopPropagation(); 
            if (isEraserMode || isLocked) return;
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const currentName = grp.tasks[taskIndex].subtasks[subIndex].name;
            const newName = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÁ¥∞È†ÖÂêçÁ®±Ôºö", currentName);
            if (newName && newName.trim() !== "") {
                grp.tasks[taskIndex].subtasks[subIndex].name = newName.trim();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderGroupView();
            }
        }
        function deleteTask(taskIndex, event) {
            event.stopPropagation(); 
            if (isLocked) return;
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const name = grp.tasks[taskIndex].title;
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§‰ªªÂãô„Äå${name}„ÄçÂóéÔºü`)) {
                grp.tasks.splice(taskIndex, 1); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                renderGroupView();
            }
        }

        function addGroup() {
            if (isLocked) return;
            const cat = projectData.categories[activeCategoryIndex];
            const name = prompt("Ë´ãËº∏ÂÖ•Êñ∞Á´†ÁØÄÂêçÁ®± (‰æãÂ¶Ç S03)Ôºö", `Êñ∞Á´†ÁØÄ ${cat.groups.length + 1}`);
            if (!name) return; 

            let templateSubtasks = [{name: "Â∑•‰ΩúÁ¥∞È†Ö", done: false}];
            if (cat.groups.length > 0 && cat.groups[0].tasks.length > 0) {
                templateSubtasks = cat.groups[0].tasks[0].subtasks.map(st => ({ name: st.name, done: false }));
            }
            cat.groups.push({ name: name, tasks: [{ id: `t_${Date.now()}`, title: "Êñ∞‰ªªÂãô", expanded: true, subtasks: templateSubtasks }] });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            renderCategoryView();
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
        function addTask() {
            if (isEraserMode || isLocked) return; 
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            const taskName = prompt("Ë´ãËº∏ÂÖ•Êñ∞‰ªªÂãôÂêçÁ®±Ôºö", `Êñ∞Â¢û‰ªªÂãô ${grp.tasks.length + 1}`);
            if (!taskName) return; 

            let templateSubtasks = [{name: "Â∑•‰ΩúÁ¥∞È†Ö", done: false}];
            if (grp.tasks.length > 0) {
                templateSubtasks = grp.tasks[0].subtasks.map(st => ({ name: st.name, done: false }));
            }
            grp.tasks.push({ id: `t_${Date.now()}`, title: taskName, expanded: true, subtasks: templateSubtasks });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            renderGroupView();
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function openCategory(index) {
            activeCategoryIndex = index;
            const cat = projectData.categories[index];
            
            if (!cat.hasLayers) {
                activeGroupIndex = 0; 
                renderGroupView();
            } else {
                activeGroupIndex = null;
                renderCategoryView();
            }
        }
        function openGroup(index) {
            activeGroupIndex = index;
            renderGroupView();
        }
        function goBackToProject() {
            activeCategoryIndex = null;
            activeGroupIndex = null;
            renderProjectView();
        }
        function goBackToCategory() {
            const cat = projectData.categories[activeCategoryIndex];
            cat.groups[activeGroupIndex].tasks.forEach(t => t.expanded = false);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            
            if (!cat.hasLayers) {
                goBackToProject();
            } else {
                activeGroupIndex = null;
                renderCategoryView();
            }
        }
        function toggleTask(taskIndex) {
            const grp = projectData.categories[activeCategoryIndex].groups[activeGroupIndex];
            grp.tasks[taskIndex].expanded = !grp.tasks[taskIndex].expanded;
            renderGroupView();
        }

        function toggleSubtask(taskIndex, subIndex, checkboxElem) {
            const cat = projectData.categories[activeCategoryIndex];
            const grp = cat.groups[activeGroupIndex];
            const task = grp.tasks[taskIndex];
            
            const wasTaskCompleted = getTaskStats(task).percentage === 100;
            const wasGrpCompleted = getGroupStats(grp).percentage === 100;
            const wasCatCompleted = getCategoryStats(cat).percentage === 100;
            
            task.subtasks[subIndex].done = !task.subtasks[subIndex].done;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));

            const isTaskNowCompleted = getTaskStats(task).percentage === 100;
            const isGrpNowCompleted = getGroupStats(grp).percentage === 100;
            const isCatNowCompleted = getCategoryStats(cat).percentage === 100;

            const rect = checkboxElem.getBoundingClientRect();
            const x = rect.left + (rect.width / 2);
            const y = rect.top + (rect.height / 2);

            if (!wasTaskCompleted && isTaskNowCompleted) { fireConfetti(x, y, 40, false); }
            if (!wasGrpCompleted && isGrpNowCompleted && cat.hasLayers) {
                setTimeout(() => { fireConfetti(window.innerWidth / 2, window.innerHeight / 2, 100, true); }, 300);
            }
            if (!wasCatCompleted && isCatNowCompleted) {
                setTimeout(() => { fireConfetti(window.innerWidth / 2, window.innerHeight / 2, 250, true); }, 600);
            }
            renderGroupView();
        }

        document.addEventListener('click', function(event) {
            if (activeGroupIndex === null) return; 
            const isClickInsideCard = event.target.closest('.task-card');
            const isClickInsideHeader = event.target.closest('.header-nav'); 
            const isClickInsideAddBtn = event.target.closest('.add-btn'); 

            if (!isClickInsideCard && !isClickInsideHeader && !isClickInsideAddBtn) {
                let changed = false;
                projectData.categories[activeCategoryIndex].groups[activeGroupIndex].tasks.forEach(task => {
                    if (task.expanded) { task.expanded = false; changed = true; }
                });
                if (changed) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
                    renderGroupView();
                }
            }
        });

        function fireConfetti(x, y, particleCount, isHuge) {
            const colors = ['#FFC700', '#FF0000', '#2E3192', '#41BBC7', '#4CAF50', '#FF69B4', '#00FFFF'];
            for (let i = 0; i < particleCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                if (isHuge) { confetti.style.width = '15px'; confetti.style.height = '15px'; } 
                else { confetti.style.width = '10px'; confetti.style.height = '10px'; }
                document.body.appendChild(confetti);
                confetti.style.left = x + 'px'; confetti.style.top = y + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const angle = Math.random() * Math.PI * 2;
                const velocity = (isHuge ? 100 : 50) + Math.random() * (isHuge ? 250 : 150);
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity - (isHuge ? 150 : 80); 
                confetti.style.setProperty('--tx', `${tx}px`);
                confetti.style.setProperty('--ty', `${ty}px`);
                setTimeout(() => confetti.remove(), 1000);
            }
        }

        // ÂàùÂßãÂåñ
        renderRoadmap();
        renderProjectView();
        document.getElementById('btn-lock').innerText = isLocked ? 'üîí' : 'üîì';
    </script>
</body>
</html>
